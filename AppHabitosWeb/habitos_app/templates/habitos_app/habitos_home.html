{% extends "base_app/base_app.html" %}
{% load static %}

{% block title %}

<title>Gabitos</title>
  
{% endblock title %}


{% block head %}

    <!-- cambiar despues por paquete de node -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>


    <script src="https://d3js.org/d3.v7.min.js"></script>

     <script src="https://unpkg.com/cal-heatmap/dist/cal-heatmap.min.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/cal-heatmap/dist/cal-heatmap.css">

    <script src="https://unpkg.com/@popperjs/core@2"></script>
    <script src="https://unpkg.com/cal-heatmap/dist/plugins/Tooltip.min.js"></script>
    <script src="https://unpkg.com/cal-heatmap/dist/plugins/Legend.min.js"></script>
    <script src="https://unpkg.com/cal-heatmap/dist/plugins/LegendLite.min.js"></script>
    <script src="https://unpkg.com/cal-heatmap/dist/plugins/CalendarLabel.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>



    <!-- <script type="text/javascript" src="//d3js.org/d3.v3.min.js"></script>
    <script type="text/javascript" src="//cdn.jsdelivr.net/cal-heatmap/3.3.10/cal-heatmap.min.js"></script>
    <link rel="stylesheet" href="//cdn.jsdelivr.net/cal-heatmap/3.3.10/cal-heatmap.css" /> -->
    
    
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

<link rel="stylesheet" href="{% static 'base_app/css/home.css'  %}">
    
<link rel="stylesheet" href="{% static 'base_app/css/formulario_habito.css'  %}">
<link rel="stylesheet" href="{% static 'habitos_app/css/grafico_habito.css'  %}">
<link rel="stylesheet" href="{% static 'base_app/css/grafico.css'  %}">
<link rel="stylesheet" href="{% static 'base_app/css/tags.css'  %}">
<link rel="stylesheet" href="{% static 'habitos_app/css/estadisticas_tags.css'  %}">


{% endblock head %}


{% block content %}



{% if request.user.is_anonymous %}
<div class="flex flex-col gap-2 justify-center items-center h-screen w-screen" >
  
        <a href="{% url 'login' %}">
          <button type="button" class="flex w-full items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
            Iniciar sesión
          </button>
        </a>
  
        <a href="{% url 'signup' %}">
          <button type="button" class="flex w-full items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
            Registrarse
          </button>
        </a>
  
  </div>
{% else%}





<div class="columnas">

 


    <div class="columna1">

        <div id="ventana1" class="ventana">

            <div class="conotenedor-superior">

                <div class="contenedor_datos_superior">


                    
                      <div class="mt-auto ">
                    
                          <div class="relative inline-block text-left">
                            <div>
                              <button type="button" class="inline-flex m-1 justify-center w-full rounded-md border border-gray-300 shadow-sm text-sm font-medium focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-offset-gray-100 focus:ring-indigo-500 dropbtn" id="options-menu" aria-haspopup="true" aria-expanded="true">
                                <!-- {% if request.user.profile.picture.url != null %}
                                  <img class="h-10" src="{{ request.user.profile.picture.url }}" alt="" loading="lazy"/>
                                {% else %}
                                  <img class="h-10" src="{% static '..\media\default\user.png' %}" alt="" loading="lazy"/>
                                {% endif %} -->
                                <div class="icon-container mt-1">

                                    <i class="material-icons">more_vert</i>
                                </div>
                              </button>
                            </div>
                            <div id="myDropdown" class="dropdown-content origin-top-left absolute left-0 w-46 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5">
                              <div class="py-1" role="menu" aria-orientation="vertical" aria-labelledby="options-menu">
                                  <button class="w-full text-left block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900" onclick="configurar_habito_nuevo()"> Agregar Habito</button>
                                  <button class="w-full text-left block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900" onclick="ActivarOrdenarLista()"> Ordenar Lista</button>
                                  <button class="w-full text-left block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900" onclick="mostrarEstadisticasTags()"> Estadísticas por Tags</button>
                              
                                <!-- <a href="{% url 'importarArchivos' %}" class=" block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900" role="menuitem">Importar</a> -->
                                <!-- <a href="{% url 'details_profile' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900" role="menuitem">Mi Perfil</a> -->
                                <a href="{% url 'update_profile' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900" role="menuitem">Configurar cuenta</a>
                                <a href="{% url 'logout' %}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 hover:text-gray-900" role="menuitem">Cerrar sesión</a>
                            </div>
                            </div>
                          </div>
                      
                       
                     
                      </div>
                    
                      {% if not request.user.is_anonymous %}

                      

                    <!-- <button class="material-icons" onclick="configurar_habito_nuevo()"> add</button>
                    <button class="material-icons" onclick="ActivarOrdenarLista()"> sort</button> -->

                    <h4 id="tiempo_restante"></h4>
                    <h4 id="horas_completadas"></h4>
                    <h4 id="tareas_restantes"></h4>

                    {% endif %}
                </div>

                {% if not request.user.is_anonymous %}
                <div class="contenedor-bar mt-1">
                    <!-- Barra de progreso del día -->
                    <div class="progress-bar">
                        <progress id="progress-dia" value="0" max="100"></progress>
                        <div class="progress-text">0% del día</div>
                    </div>
                </div>
                
                <div class="contenedor-bar mt-1">
                    <!-- Barra de progreso de las tareas -->
                    <div class="progress-bar">
                        <progress id="progress-tareas" value="0" max="100"></progress>
                        <div class="progress-text progress-text-tareas">0% tareas</div>
                    </div>
                </div>

                    {% endif %}

            </div>


            {% if not request.user.is_anonymous %}


            <div class="detalles_lista">

                <ul class="text-black" id="miLista">
            </div>
            </ul>
            <details id="details_lista_hecha">
                <summary>Tareas completadas hoy</summary>
                <ul class="text-black" id="miLista_hechos">
            </details>
            </ul>
            <details id="details_lista_hecha">
                <summary>Tareas Archivadas</summary>
                <ul class="text-black" id="miLista_archivados">
            </details>
            </ul>

            {% endif %}

        </div>

        <div id="ventana2" class="ventana" style="display: none;">
            
            <div class="botones_superior">
                <button class="material-icons" onclick="cambiarVentana('ventana1')">arrow_back</button>
                <button class="material-icons" id="boton_borrar" onclick="eliminar_habito()">delete</button>
                <button class="material-icons" id="archivar_borrar" onclick="archivarHabito(1)">archive</button>
                <button class="material-icons" id="des_archivar_borrar" onclick="archivarHabito(0)">unarchive</button>

            </div>
            <h2 id="titulo_habito"></h2>
            <div  class="contenedor_formulario text-black">


                <div id="formDiv">

                    <label for="nombre">Nombre:</label>
                    <input class="imput_form" type="hidden" id="id" name="id">
                    <input class="imput_form" type="hidden" id="orden_n" name="orden_n">
                    <input class="imput_form" type="text" id="nombre" name="nombre">
                    
                    <label for="comentarios">Comentarios:</label>
                    <textarea class="imput_form" id="comentarios" name="comentarios" rows="3" placeholder="Agrega detalles sobre este hábito..."></textarea>
                    
                    <label for="work_time">Work Time:</label>
                    <input class="imput_form" type="number" id="work_time" name="work_time">
                    <label for="short_break">Short Break:</label>
                    <input class="imput_form" type="number" id="short_break" name="short_break">
                    <label for="count">Count:</label>
                    <input class="imput_form" type="number" id="count" name="count">
                    <label for="objetivo">Objetivo:</label>
                    <input class="imput_form" type="number" id="objetivo" name="objetivo">
                    <label for="type">Type:</label>
                    <select class="imput_form" id="type" name="type">
                        <option value="1">Pomodoro</option>
                        <option value="2">Checker</option>
                        <option value="3">StopWatch</option>
                    </select>
                    <div class="tags-section mt-4">
                        <label>Tags:</label>
                        <div id="selected-tags" class="flex flex-wrap gap-2 mt-2">
                            <!-- Selected tags will be displayed here -->
                        </div>
                        <div class="flex items-center mt-2">
                            <button type="button" class="bg-blue-500 text-white px-2 py-1 rounded text-sm" onclick="mostrarVentanaGestionTags()">
                                Gestionar Tags
                            </button>
                        </div>
                        <input type="hidden" id="tags_seleccionados" name="tags_seleccionados" value="[]">
                    </div>
                    <div class="dias-seleccionados">
                        <label>Días de la semana:</label>
                        <div class="dias-checkbox flex flex-wrap gap-2 mt-2">
                            <label class="relative cursor-pointer">
                                <input type="checkbox" name="dias" value="1" checked class="peer sr-only">
                                <span class="w-8 h-8 flex items-center justify-center rounded-full border-2 border-gray-300 peer-checked:bg-blue-500 peer-checked:border-blue-500 peer-checked:text-white bg-red-500 text-white font-bold transition-colors">L</span>
                            </label>
                            <label class="relative cursor-pointer">
                                <input type="checkbox" name="dias" value="2" checked class="peer sr-only">
                                <span class="w-8 h-8 flex items-center justify-center rounded-full border-2 border-gray-300 peer-checked:bg-blue-500 peer-checked:border-blue-500 peer-checked:text-white bg-red-500 text-white font-bold transition-colors">M</span>
                            </label>
                            <label class="relative cursor-pointer">
                                <input type="checkbox" name="dias" value="3" checked class="peer sr-only">
                                <span class="w-8 h-8 flex items-center justify-center rounded-full border-2 border-gray-300 peer-checked:bg-blue-500 peer-checked:border-blue-500 peer-checked:text-white bg-red-500 text-white font-bold transition-colors">X</span>
                            </label>
                            <label class="relative cursor-pointer">
                                <input type="checkbox" name="dias" value="4" checked class="peer sr-only">
                                <span class="w-8 h-8 flex items-center justify-center rounded-full border-2 border-gray-300 peer-checked:bg-blue-500 peer-checked:border-blue-500 peer-checked:text-white bg-red-500 text-white font-bold transition-colors">J</span>
                            </label>
                            <label class="relative cursor-pointer">
                                <input type="checkbox" name="dias" value="5" checked class="peer sr-only">
                                <span class="w-8 h-8 flex items-center justify-center rounded-full border-2 border-gray-300 peer-checked:bg-blue-500 peer-checked:border-blue-500 peer-checked:text-white bg-red-500 text-white font-bold transition-colors">V</span>
                            </label>
                            <label class="relative cursor-pointer">
                                <input type="checkbox" name="dias" value="6" checked class="peer sr-only">
                                <span class="w-8 h-8 flex items-center justify-center rounded-full border-2 border-gray-300 peer-checked:bg-blue-500 peer-checked:border-blue-500 peer-checked:text-white bg-red-500 text-white font-bold transition-colors">S</span>
                            </label>
                            <label class="relative cursor-pointer">
                                <input type="checkbox" name="dias" value="7" checked class="peer sr-only">
                                <span class="w-8 h-8 flex items-center justify-center rounded-full border-2 border-gray-300 peer-checked:bg-blue-500 peer-checked:border-blue-500 peer-checked:text-white bg-red-500 text-white font-bold transition-colors">D</span>
                            </label>
                        </div>
                    </div>
                    <div id="colorPalette"></div>
                    <input class="imput_form" type="hidden" id="color_hab" name="color_hab">
                    <input class="imput_form" type="hidden" id="archivado" name="archivado">
                    <button id="boton_agregar" onclick="guardar_habito_json()">Guardar</button>
                </div>
            </div>
        </div>


        <div id="ventana3" class="ventana" style="display: none;">
            <button class="material-icons" onclick="ActivarOrdenarLista()"> sort</button>
            <button class="material-icons" onclick="saveNewListSort()"> save</button>


            <ul id="miLista_ParaOrdenar">
        </div>

        <div id="ventana4" class="ventana" style="display: none;">
            <div class="botones_superior">
                <button class="material-icons" onclick="cambiarVentana('ventana2')">arrow_back</button>
                <button class="material-icons" onclick="mostrarFormularioTag()">add</button>
            </div>
            <h2>Gestión de Tags</h2>
            
            <div id="form-tag" style="display: none;" class="contenedor_formulario text-black">
                <h3 id="titulo-form-tag">Crear nuevo tag</h3>
                <input class="imput_form" type="hidden" id="tag_id" name="tag_id">
                <label for="tag_nombre">Nombre:</label>
                <input class="imput_form" type="text" id="tag_nombre" name="tag_nombre">
                <label for="tag_descripcion">Descripción:</label>
                <input class="imput_form" type="text" id="tag_descripcion" name="tag_descripcion">
                <label for="tag_color">Color:</label>
                <input class="imput_form" type="color" id="tag_color" name="tag_color" value="#CCCCCC">
                
                <!-- Paleta de colores para tags -->
                <div class="mt-2">
                    <label>Seleccionar color:</label>
                    <div id="tag_colorPalette" class="color-palette mt-1">
                        <!-- Los colores se cargarán dinámicamente aquí -->
                    </div>
                </div>
                
                <div class="flex gap-2 mt-3">
                    <button onclick="guardarTag()">Guardar</button>
                    <button onclick="cancelarFormularioTag()">Cancelar</button>
                </div>
            </div>
            
            <div id="lista-tags" class="mt-4">
                <h3>Tags disponibles</h3>
                <div id="tags-container" class="flex flex-wrap gap-2 mt-2">
                    <!-- Los tags se cargarán dinámicamente aquí -->
                </div>
            </div>
            
            <div id="seleccion-tags" class="mt-4">
                <h3>Seleccionar Tags para el Hábito</h3>
                <div id="tags-seleccion-container" class="flex flex-wrap gap-2 mt-2">
                    <!-- Los tags para seleccionar se cargarán dinámicamente aquí -->
                </div>
                <button id="btn-aplicar-tags" class="mt-3" onclick="aplicarTagsSeleccionados()">Aplicar selección</button>
            </div>
        </div>

        <!-- Nueva ventana para estadísticas por tags -->
        <div id="ventana5" class="ventana" style="display: none;">
            <div class="botones_superior">
                <button class="material-icons" onclick="cambiarVentana('ventana1')">arrow_back</button>
                <button class="material-icons" onclick="exportarEstadisticasTags()">download</button>
                <button class="material-icons" onclick="refrescarEstadisticasTags()">refresh</button>
            </div>
            
            <h2 class="text-center mb-4">📊 Estadísticas por Tags</h2>
            
            <!-- Filtros y controles -->
            <div class="filtros-estadisticas mb-4 p-4 bg-gray-100 rounded">
                <div class="flex flex-wrap gap-4 items-center">
                    <div class="filter-group">
                        <label for="tag-filter" class="block text-sm font-medium text-gray-700">Filtrar por Tag:</label>
                        <select id="tag-filter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm text-black">
                            <option value="">Todos los tags</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="periodo-filter" class="block text-sm font-medium text-gray-700">Período:</label>
                        <select id="periodo-filter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm text-black">
                            <option value="7">Últimos 7 días</option>
                            <option value="30" selected>Últimos 30 días</option>
                            <option value="90">Últimos 90 días</option>
                            <option value="365">Último año</option>
                            <option value="all">Todo el tiempo</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <button id="aplicar-filtros" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
                            Aplicar Filtros
                        </button>
                    </div>
                </div>
            </div>

            <!-- Resumen de estadísticas principales -->
            <div class="estadisticas-resumen grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                <div class="stat-card bg-white p-4 rounded shadow">
                    <h3 class="text-lg font-semibold text-gray-700">Total de Tiempo</h3>
                    <p id="total-tiempo-tags" class="text-2xl font-bold text-blue-600">0h 0m</p>
                </div>
                <div class="stat-card bg-white p-4 rounded shadow">
                    <h3 class="text-lg font-semibold text-gray-700">Tag Más Activo</h3>
                    <p id="tag-mas-activo" class="text-2xl font-bold text-green-600">-</p>
                </div>
                <div class="stat-card bg-white p-4 rounded shadow">
                    <h3 class="text-lg font-semibold text-gray-700">Día Más Productivo</h3>
                    <p id="dia-mas-productivo" class="text-2xl font-bold text-orange-600">-</p>
                </div>
                <div class="stat-card bg-white p-4 rounded shadow">
                    <h3 class="text-lg font-semibold text-gray-700">Promedio Diario</h3>
                    <p id="promedio-diario-tags" class="text-2xl font-bold text-purple-600">0h 0m</p>
                </div>
            </div>

            <!-- Gráficos principales -->
            <div class="graficos-container grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                <!-- Gráfico de distribución por tags -->
                <div class="grafico-card bg-white p-4 rounded shadow">
                    <h3 class="text-lg font-semibold mb-3">Distribución de Tiempo por Tags</h3>
                    <div class="chart-container" style="position: relative; height: 300px;">
                        <canvas id="grafico-distribucion-tags"></canvas>
                    </div>
                </div>

                <!-- Gráfico de tendencia temporal -->
                <div class="grafico-card bg-white p-4 rounded shadow">
                    <h3 class="text-lg font-semibold mb-3">Tendencia Temporal por Tags</h3>
                    <div class="chart-container" style="position: relative; height: 300px;">
                        <canvas id="grafico-tendencia-tags"></canvas>
                    </div>
                </div>

                <!-- Gráfico de comparación diaria -->
                <div class="grafico-card bg-white p-4 rounded shadow">
                    <h3 class="text-lg font-semibold mb-3">Comparación Diaria</h3>
                    <div class="chart-container" style="position: relative; height: 300px;">
                        <canvas id="grafico-comparacion-diaria"></canvas>
                    </div>
                </div>

                <!-- Gráfico de eficiencia por objetivos -->
                <div class="grafico-card bg-white p-4 rounded shadow">
                    <h3 class="text-lg font-semibold mb-3">Eficiencia por Tag (Objetivo vs Real)</h3>
                    <div class="chart-container" style="position: relative; height: 300px;">
                        <canvas id="grafico-eficiencia"></canvas>
                    </div>
                </div>
            </div>

            <!-- Tabla detallada -->
            <div class="tabla-detallada bg-white p-4 rounded shadow">
                <h3 class="text-lg font-semibold mb-3">Detalles por Tag</h3>
                <div class="overflow-x-auto">
                    <table id="tabla-stats-tags" class="min-w-full table-auto">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tag</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tiempo Total</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sesiones</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Promedio/Sesión</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Último Uso</th>
                                <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tendencia</th>
                            </tr>
                        </thead>
                        <tbody id="tabla-stats-body" class="bg-white divide-y divide-gray-200">
                            <!-- Se llenará dinámicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>









    </div>
    {% if not request.user.is_anonymous %}
    <div class="columna2" id="columna2-id">

        
        <div class="heatmap_principal">
            
            <div id="header"></div>
            
            <div class="div_totales">
                <h4 class="h_total" id="horas_invertidas_habito"></h4>
                <h4 class="h_total" id="dias_totales_invertidas_habito"></h4>
            </div>

            <div class="desktop_vew">

                <div style="justify-content: center; display: flex;"  >
    
                    <div class="center_div arriba_e"  >
                        <button class="botones_nyp" id="minDate-previous_year"> < </button>
                        <div id="cal-heatmap"></div>
                        <button class="botones_nyp" id="minDate-next_year">></button>
                        
                    </div>
                </div>
            </div>
            
            <div class="desktop_vew" id="legendY" style="margin-bottom: 5px; float: right;" ></div>
            <div class="center_div">
            </div>
            <div>
                <div style="justify-content: center; display: flex; height: 170px; width: 350px;">

                    <canvas class="desktop_vew" id="miGrafico"></canvas>

                    <div class="center_div">

                        <button class="botones_nyp" id="minDate-previous"> < </button>
                                <div id="mes_habito"></div>
                                <button class="botones_nyp" id="minDate-next">></button>
                    </div>
                </div>

            </div>
            <div id="onClick-placeholder">

            </div>
            <div class="text-black flex justify-center flex-col gap-1 justify-between" id="form_edicion_historial">

                <input class="imput_form" type="hidden" id="id_historial_habito" name="id_historial_habito">
                <input class="imput_form" type="hidden" id="fecha_historial" name="fecha_historial">
                <input class="imput_form" type="hidden" id="objeto_historial" name="objeto_historial">
                <input class="imput_form" type="hidden" id="objeto_habito_edicion" name="objeto_habito_edicion">
                <!-- <input id="duracion_historial" type="text"> -->
                <div class="flex gap-1 selecters-time ">
                    <select class="text-black rounded-sm" id="hora" name="hora">
                    </select>
                    <br>
                    <label for="minutos">:</label><br>
                    <select class="text-black rounded-sm" id="minutos" name="minutos">
                    </select>
                    <br>
                    <label for="segundos">:</label><br>
                    <select  class="text-black rounded-sm" id="segundos" name="segundos">
                    </select>
                   
                </div>
                <button class="boton_editarHistorial rounded-sm w-100" id="boton_agregar" onclick="agregarEditarHabito()">Guardar</button>
            </div>

        </div>







        <div class="desktop_vew" style="justify-content: center; display: flex;">



            <div class="center_div"> 
            <div  style="width: 950px; height: 250px;" class="center_div  desktop_vew"  >
                <div class="button-container">
                </div>

                    <button class="botones_nyp" id="prevButton"> < </button>
                    <canvas class="desktop_vew" id="myChart"></canvas>
                    <button class="botones_nyp" id="nextButton">></button>
                </div>

            </div>
        </div>



    </div>

    {% endif %}
</div>

{% endif %}

{% endblock content %}



{% block script_sup %}

<script>
// Función para obtener el token CSRF de las cookies
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>
  
<script src="{% static 'habitos_app/js/grafico_habito.js' %}"></script>
<script src="{% static 'habitos_app/js/barra_grafico_habito.js' %}"></script>

<script src="{% static 'base_app/js/lista_habito_script.js' %}"></script>
<script src="{% static 'base_app/js/time_day.js' %}"></script>
<script src="{% static 'base_app/js/formulario_habito.js' %}"></script>
<script src="{% static 'base_app/js/tags_manager.js' %}"></script>
<script src="{% static 'base_app/js/principal.js' %}"></script>
<script src="{% static 'habitos_app/js/estadisticas_tags.js' %}"></script>

{% comment %} grafico {% endcomment %}
<script>

    function holaa(){
        console.log('holaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaholaaaaaaaaaaaaaa')
    }

    function get_datos_historial(idHabito, fechaHabito, archivo) {
        //  const data = fs.readFileSync(archivo, 'utf8');
        //  const records = Papa.parse(data, {
        //      header: true,
        //      skipEmptyLines: true
        //  }).data;
        
        //  for (let record of records) {
        //      if (parseInt(record.id_habito) === idHabito && record.fecha === fechaHabito) {
        //          console.log(record); // Imprime todo el registro en la consola
        //          return record
        //      }
        //  }

        datos = {
            'fecha': fechaHabito
        }
        
        var url = `/habitos/getOneHistorial/${idHabito}`;
        return fetch(url,{
            method : 'POST',
            headers : {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{csrf_token}}' 
            },
            body: JSON.stringify(datos)
        })
        .then(function(response) {
            if (!response.ok) {
                throw new Error('La solicitud falló');
            }
            return response.json();
        })
        .catch(function(error) {
            console.error('Error:', error);
        });
        
        
        }


        function agregarEditarHabito() {
            id_habitoObjet = document.getElementById("id_historial_habito")
            id_habito = id_habitoObjet.value
            //duracion_historialobject = document.getElementById("duracion_historial")

            var horas = parseInt(document.getElementById('hora').value);
            var minutos = parseInt(document.getElementById('minutos').value);
            var segundos = parseInt(document.getElementById('segundos').value);


            console.log(segundos)
            //var totalMinutos = horas * 60 + minutos + ( segundos / 60) ;
            //console.log(totalMinutos)
          
            var objeto_historial_leido = {}
            var objeto_historial = document.getElementById("objeto_historial");
            var objetoGuardado_historial = objeto_historial.dataset.objeto;
            if (objetoGuardado_historial) {
              objeto_historial_leido = JSON.parse(objetoGuardado_historial);
                console.log("Objeto recuperado:", objeto_historial_leido);
            } else {
                console.log("No hay ningún objeto guardado.");
            }
          
            fecha_historial = document.getElementById("fecha_historial").value
          
            //duracion_historial = duracion_historialobject.value
            //duracion_historial = totalMinutos
            // let data = fs.readFileSync('historial_habitos.csv', 'utf8');
            // let records = Papa.parse(data, {header: true}).data;
            console.log(objeto_historial_leido)
            //console.log('se guardara en -', id_habito, ' el tiempo', duracion_historial, 'en-', objeto_historial_leido.objeto_historial.fecha)
          
            // let hoy = moment().format('YYYY-MM-DD');
            // let hora = moment().format('HH:mm:ss');
          
            fechaSeleccionada = fecha_historial
            console.log(fechaSeleccionada)


            var datos = {
                fecha: fechaSeleccionada,
                horas: horas,
                minutos: minutos,
                segundos: segundos
            };
            
            url = `/habitos/editarDuracionForm_Habito/${id_habito}`
            
            fetch(url, {
                method : 'POST',
                headers : {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{csrf_token}}' 
                },
                body: JSON.stringify(datos)
            } )
            .then(function(response){
                if (!response.ok){
                    throw new Error('error')
                }
                return response.json()
            })
            .then(function(data){
                console.log(data)
                definir(data.objetoHabito)
                generarGraficoDuracionPorAnio(data.objetoHabito['id']+'', data.objetoHabito['objetivo']);
                graficar_semana(data.objetoHabito['id']+'', data.objetoHabito['objetivo']);
                var objetoDatos = document.getElementById("objeto_habito_edicion");
                actualizar_listas(true)
                /*
                var objetoGuardado = objetoDatos.dataset.objeto;
                if (objetoGuardado) {
                    var objeto = JSON.parse(objetoGuardado);
                    console.log("Objeto recuperado:", objeto);
                    definir(objeto)
                    generarGraficoDuracionPorAnio(objeto.id+'', objeto.objetivo);
                    graficar_semana(objeto.id+'', objeto.objetivo);
                } else {
                    console.log("No hay ningún objeto guardado.");
                }
                */
                id_habitoObjet.value = ''
                //duracion_historialobject.value = ''
                objetoDatos.dataset = {}

            })




          
            // let existeHoy = records.some(record => moment(record.fecha).format('YYYY-MM-DD') === fecha_historial && record.id_habito === id_habito);
            // console.log(existeHoy)
            // console.log("--eeeeeeeeeeeeeeettttttttttttttttttteeeeeuuuuuuuuuuuuaaaaaaaaaaaaaaaaaaaaaaaaaaa")
            // if (!existeHoy) {
            //     let nueva_fila = {
            //         id_habito: id_habito,
            //         fecha: fecha_historial,
            //         duracion: duracion_historial,
            //         start_timer: hora,
            //         end_timer: 0,
            //         duracion_descanso: 0
            //     };
            //     records.push(nueva_fila);
            // }else{
            //   records.forEach(record => {
            //     if(moment(record.fecha).format('YYYY-MM-DD') === fechaSeleccionada && record.id_habito === id_habito) {
            //         record.duracion = duracion_historial;
            //     }
            // });
            // }
          
            // let csv = Papa.unparse(records);
            // fs.writeFileSync('historial_habitos.csv', csv);
            
         
          
          
          }

</script>
      
    {% endblock script_sup %}



{% block script %}
<script>
    // Comentado temporalmente mientras se implementa la funcionalidad de tags
    // llenar_lista_habitos('miLista', false, false, {{Habitos_por_hacer|safe}})
    // llenar_lista_habitos('miLista_hechos', false, false, {{Habitos_hechos|safe}})
</script>

<script>
    function guardar_habito_json () {
        var datos = {
          id: Number(document.getElementById('id').value),
          nombre: document.getElementById('nombre').value,
          comentarios: document.getElementById('comentarios').value,
          work_time: Number(document.getElementById('work_time').value),
          short_break: Number(document.getElementById('short_break').value),
          count: Number(document.getElementById('count').value),
          type: Number(document.getElementById('type').value),
          orden_n: Number(document.getElementById('orden_n').value),
          color: document.getElementById('color_hab').value || 'FFFFFF',
          objetivo: Number(document.getElementById('objetivo').value),
          archivado: document.getElementById('archivado').value === 'true',
          dias_seleccionados: Array.from(document.querySelectorAll('input[name="dias"]:checked'))
            .map(checkbox => checkbox.value)
            .join(','),
          tags: JSON.parse(document.getElementById('tags_seleccionados').value || '[]')
      };
      
      url = '/habitos/guardar_habito/'
      
      fetch(url, {
          method : 'POST',
          headers : {
              'Content-Type': 'application/json',
              'X-CSRFToken': '{{csrf_token}}' 
          },
          body: JSON.stringify(datos)
      } )
      .then(function(response){
          if (!response.ok){
              throw new Error('error')
          }
          return response.json()
      })
      .then(function(data){
          console.log(data)
          actualizar_listas(true)
          cambiarVentana('ventana1')
      })

      }


      function agregar_Nuevo_habito_js () {

        var datos = {
          id: Number(document.getElementById('id').value),
          nombre: document.getElementById('nombre').value,
          comentarios: document.getElementById('comentarios').value,
          work_time: Number(document.getElementById('work_time').value),
          short_break: Number(document.getElementById('short_break').value),
          count: Number(document.getElementById('count').value),
          type: Number(document.getElementById('type').value),
          orden_n: Number(document.getElementById('orden_n').value),
          color: document.getElementById('color_hab').value,
          objetivo: Number(document.getElementById('objetivo').value)
      };
      
      url = `/habitos/set_NewHabitoformHabito/`
      
      fetch(url, {
          method : 'POST',
          headers : {
              'Content-Type': 'application/json',
              'X-CSRFToken': '{{csrf_token}}' 
          },
          body: JSON.stringify(datos)
      } )
      .then(function(response){
          if (!response.ok){
              throw new Error('error')
          }
          return response.json()
      })
      .then(function(data){
          console.log(data)
          actualizar_listas(true)
          cambiarVentana('ventana1')
          
      })
      }

    </script>


    <script>
        function eliminar_habito () {
            // const data = fs.readFileSync('data.json', 'utf8')
            // let jsonData = JSON.parse(data)
            // Buscar el índice del objeto con el id dado
            const idParaEliminar = Number(document.getElementById('id').value)
          
            // Filtrar el array para excluir el objeto con el id dado
            // jsonData = jsonData.filter(item => item.id !== idParaEliminar)
          
          
            var datos = {
              id: idParaEliminar
          };
            url = `/habitos/delete_habito/`
                
            fetch(url, {
                method : 'POST',
                headers : {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{csrf_token}}' 
                },
                body: JSON.stringify(datos)
            } )
            .then(function(response){
                if (!response.ok){
                    throw new Error('error')
                }
                return response.json()
            })
            .then(function(data){
                // console.log(data)
                // actualizar_listas()
                // cambiarVentana('ventana1')
          
          
                 // Guardar el nuevo array en el archivo JSON
            // fs.writeFileSync('data.json', JSON.stringify(jsonData, null, 2), 'utf8')
            console.log('Registro eliminado')
            actualizar_listas(true)
            cambiarVentana('ventana1')
                
            })
          
           
          }



          function archivarHabito(SeVaArchivar){
            // const data = fs.readFileSync('data.json', 'utf8')
            // const dataJson = JSON.parse(data)
          
            habito = Number(document.getElementById('id').value) 
            console.log(habito)

            
          
             // Buscar el índice del objeto con el id dado
             // const index = dataJson.findIndex(item => item.id === habito)
          
             // Si el objeto existe, actualizarlo
             //if (index !== -1) {
              // dataJson[index].archivado = SeVaArchivar
               // fs.writeFileSync('data.json', JSON.stringify(dataJson, null, 2), 'utf8')
              // console.log('guardardó')
             // } else {
               // Si el objeto no existe, puedes decidir qué hacer (por ejemplo, añadirlo al array)
              // console.log('El objeto con id ' + habito.id + ' no existe')
            // }


               
            var datos = {
                id: habito
            };
              url = `/habitos/archivar_habito/`
                  
              fetch(url, {
                  method : 'POST',
                  headers : {
                      'Content-Type': 'application/json',
                      'X-CSRFToken': '{{csrf_token}}' 
                  },
                  body: JSON.stringify(datos)
              } )
              .then(function(response){
                  if (!response.ok){
                      throw new Error('error')
                  }
                  return response.json()
              })
              .then(function(data){
                  // console.log(data)
                  // actualizar_listas()
                  // cambiarVentana('ventana1')
            
            
                   // Guardar el nuevo array en el archivo JSON
              // fs.writeFileSync('data.json', JSON.stringify(jsonData, null, 2), 'utf8')
              console.log('Registro archivado')
              actualizar_listas(true)
              cambiarVentana('ventana1')
                  
              })
            
          
            // actualizar_listas()
            // cambiarVentana('ventana1')
          
          
          }

          function saveNewListSort(){
            const ids = [];
            const elementos_all = document.getElementById('miLista_ParaOrdenar')
            const elementos_li = elementos_all.children
          
            for (let i = 0; i < elementos_li.length; i++) {
              const objStr = elementos_li[i].dataset.obj
              const obj2 = JSON.parse(objStr)
              console.log(obj2.id, '-', obj2.nombre, '-' , i)
              ids.push(obj2.id);
            }
            
            console.log(ids);

            url = `/habitos/set_listHabitos_Sort/`
                  
            fetch(url, {
                method : 'POST',
                headers : {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{csrf_token}}' 
                },
                body: JSON.stringify(ids)
            })
            .then(function(response){
                if (!response.ok){
                    throw new Error('error')
                }
                return response.json()
            })
            .then(function(data){
                if (data.status === 'success') {
                    // Destruir el sortable y limpiar la lista
                    sortable.destroy();
                    elementos_all.innerHTML = '';
                    
                    // Cambiar las ventanas
                    ventanalistas = document.getElementById('ventana1')
                    ventanaOrdenar = document.getElementById('ventana3')
                    ventanalistas.style.display = 'block'
                    ventanaOrdenar.style.display = 'none'
                    
                    // Actualizar el estado y recargar las listas
                    sorteableActivado = !sorteableActivado
                    fetch_lista_habitos(true)
                } else {
                    console.error('Error al guardar el orden:', data.message)
                }
            })
            .catch(function(error) {
                console.error('Error:', error)
            })
        }
    </script>


    <script>
        function llenarDesplegable(id, max) {
            var select = document.getElementById(id);
            for (var i = 0; i <= max; i++) {
              var option = document.createElement('option');
              option.value = i;
              option.text = i;
              select.appendChild(option);
            }
          }
          
          // Llena los desplegables
          llenarDesplegable('hora', 23);
          llenarDesplegable('minutos', 59);
          llenarDesplegable('segundos', 59);
          
          // Función para mostrar estadísticas por tags
          function mostrarEstadisticasTags() {
              cambiarVentana('ventana5');
              cargarEstadisticasTags();
          }
          
          // Función para cargar estadísticas por tags
          function cargarEstadisticasTags() {
              console.log('Cargando estadísticas por tags...');
              // Esta función se implementará en el archivo estadisticas_tags.js
              if (typeof inicializarEstadisticasTags === 'function') {
                  inicializarEstadisticasTags();
              }
          }
    </script>
    
  
{% endblock script %}

<!-- Add this before the closing body tag -->
<div id="ventanaGestionTags" class="ventana" style="display: none;">
    <div class="botones_superior">
        <button class="material-icons" onclick="cerrarVentanaGestionTags()">arrow_back</button>
        <button class="material-icons" onclick="mostrarFormularioTag()">add</button>
    </div>
    <h2>Gestión de Tags</h2>
    
    <!-- Formulario para crear/editar tags -->
    <div id="form-tag" style="display: none;" class="contenedor_formulario text-black">
        <h3 id="titulo-form-tag">Crear nuevo tag</h3>
        <input type="hidden" id="tag_id" name="tag_id">
        <label for="tag_nombre">Nombre:</label>
        <input class="imput_form" type="text" id="tag_nombre" name="tag_nombre">
        <label for="tag_descripcion">Descripción:</label>
        <input class="imput_form" type="text" id="tag_descripcion" name="tag_descripcion">
        <label for="tag_color">Color:</label>
        <input class="imput_form" type="color" id="tag_color" name="tag_color" value="#CCCCCC">
        
        <!-- Paleta de colores para tags -->
        <div class="mt-2">
            <label>Seleccionar color:</label>
            <div id="tag_colorPalette" class="color-palette mt-1">
                <!-- Los colores se cargarán dinámicamente aquí -->
            </div>
        </div>
        
        <div class="flex gap-2 mt-3">
            <button onclick="guardarTag()">Guardar</button>
            <button onclick="cancelarFormularioTag()">Cancelar</button>
        </div>
    </div>
    
    <!-- Lista de tags disponibles -->
    <div id="lista-tags" class="mt-4">
        <h3>Tags disponibles</h3>
        <div id="tags-container" class="flex flex-wrap gap-2 mt-2">
            <!-- Los tags se cargarán dinámicamente aquí -->
        </div>
    </div>
</div>